# PokÃ©mon Opalo ç¿»è­¯å·¥å…·

## æ¦‚è¿°

é€™å€‹ç›®éŒ„åŒ…å«å…©å€‹ä¸»è¦å·¥å…·ï¼š

1. **extract.py** - å¾éŠæˆ²æª”æ¡ˆæå–å¯ç¿»è­¯æ–‡å­—
2. **repack.py** - å°‡ç¿»è­¯å¾Œçš„æ–‡å­—é‡æ–°æ‰“åŒ…å›éŠæˆ²æ ¼å¼

é€™äº›å·¥å…·å¯ä»¥è§£æ Ruby Marshal æ ¼å¼çš„äºŒé€²ä½è³‡æ–™æª”æ¡ˆï¼Œä¸¦å°‡æ–‡å­—æå–ç‚ºçµæ§‹åŒ–çš„ JSON æ ¼å¼ï¼Œä¾¿æ–¼ç¿»è­¯å·¥ä½œã€‚

## å®‰è£ä¾è³´

```bash
pip install rubymarshal
```

## ä½¿ç”¨æ–¹æ³•

### 1. extract.py - æå–æ–‡å­—

#### åŸºæœ¬ç”¨æ³•

```bash
python extract.py <input_file> -o <output_file>
```

#### ç¯„ä¾‹

æå– `Data/messages.dat` æª”æ¡ˆï¼š

```bash
python extract.py ../../Data/messages.dat -o ../translations/messages.json
```

å¦‚æœæœªæŒ‡å®šè¼¸å‡ºæª”æ¡ˆï¼Œé è¨­æœƒè¼¸å‡ºåˆ° `translations/<input_name>.json`ï¼š

```bash
python extract.py ../../Data/messages.dat
```

#### å‘½ä»¤åˆ—åƒæ•¸

- `input_file`: è¼¸å…¥çš„ Ruby Marshal æ ¼å¼æª”æ¡ˆï¼ˆ.dat æˆ– .rxdataï¼‰
- `-o, --output`: è¼¸å‡ºçš„ JSON æª”æ¡ˆè·¯å¾‘ï¼ˆå¯é¸ï¼‰

### 2. repack.py - é‡æ–°æ‰“åŒ…ç¿»è­¯

#### åŸºæœ¬ç”¨æ³•

```bash
python repack.py <json_file> [-r <reference_file>] [-o <output_file>]
```

#### ç¯„ä¾‹

åŸºæœ¬ç”¨æ³•ï¼ˆè‡ªå‹•åµæ¸¬åŸå§‹æª”æ¡ˆï¼‰ï¼š

```bash
python repack.py ../translations/messages.json -o ../../patches/messages.dat
```

æ˜ç¢ºæŒ‡å®šåŸå§‹æª”æ¡ˆï¼š

```bash
python repack.py ../translations/messages.json -r ../../Data/messages.dat -o ../../patches/messages.dat
```

#### å‘½ä»¤åˆ—åƒæ•¸

- `json_file`: ç¿»è­¯å¾Œçš„ JSON æª”æ¡ˆ
- `-r, --reference`: åŸå§‹ .dat æª”æ¡ˆï¼ˆç”¨æ–¼çµæ§‹åƒè€ƒï¼Œå¯è‡ªå‹•åµæ¸¬ï¼‰
- `-o, --output`: è¼¸å‡º .dat æª”æ¡ˆè·¯å¾‘ï¼ˆé è¨­: `patches/<source_name>.dat`ï¼‰
- `--force`: è·³éé©—è­‰æç¤º

## å®Œæ•´å·¥ä½œæµç¨‹

### æ­¥é©Ÿ 1: æå–æ–‡å­—

```bash
cd localization/tools
python extract.py ../../Data/messages.dat
```

é€™æœƒç”Ÿæˆ `localization/translations/messages.json`ã€‚

### æ­¥é©Ÿ 2: ç¿»è­¯æ–‡å­—

ç·¨è¼¯ç”Ÿæˆçš„ JSON æª”æ¡ˆï¼Œå¡«å…¥ `translation` æ¬„ä½ï¼š

```json
{
  "id": "section_0[1].0",
  "original": "Â¡Bienvenidos a <b>Mundo IndÃ³mito</b>!",
  "translation": "æ­¡è¿ä¾†åˆ°<b>ç‹‚é‡ä¸–ç•Œ</b>ï¼",
  "context": {...}
}
```

### æ­¥é©Ÿ 3: é‡æ–°æ‰“åŒ…

```bash
python repack.py ../translations/messages.json
```

é€™æœƒç”Ÿæˆ `patches/messages.dat`ã€‚

### æ­¥é©Ÿ 4: æ¸¬è©¦

å°‡ç”Ÿæˆçš„æª”æ¡ˆæ”¾åˆ°éŠæˆ²ç›®éŒ„æ¸¬è©¦ï¼š

```bash
cp ../../patches/messages.dat ../../Data/messages.dat
```

**æ³¨æ„**: å‹™å¿…å…ˆå‚™ä»½åŸå§‹æª”æ¡ˆï¼

## è¼¸å‡ºæ ¼å¼

ç”Ÿæˆçš„ JSON æª”æ¡ˆåŒ…å«ä»¥ä¸‹çµæ§‹ï¼š

```json
{
  "metadata": {
    "source_file": "è·¯å¾‘/messages.dat",
    "total_entries": 28599,
    "source_language": "es",
    "target_language": "zh-TW",
    "extraction_version": "1.0"
  },
  "entries": [
    {
      "id": "section_0[1].0",
      "original": "åŸå§‹è¥¿ç­ç‰™æ–‡æ–‡å­—",
      "translation": "",
      "context": {
        "parent": "section_0[1]",
        "index": 0,
        "type": "ordered_hash_key"
      }
    }
  ]
}
```

### æ¬„ä½èªªæ˜

- **id**: å­—ä¸²çš„å”¯ä¸€è­˜åˆ¥ç¬¦
- **original**: åŸå§‹è¥¿ç­ç‰™æ–‡æ–‡å­—
- **translation**: ç¿»è­¯æ–‡å­—ï¼ˆæå–æ™‚ç‚ºç©ºï¼Œä¾›ç¿»è­¯äººå“¡å¡«å¯«ï¼‰
- **context**: ä¸Šä¸‹æ–‡è³‡è¨Š
  - **parent**: çˆ¶ç´šçµæ§‹çš„æ¨™è­˜
  - **index**: åœ¨é™£åˆ—ä¸­çš„ç´¢å¼•ï¼ˆå¦‚é©ç”¨ï¼‰
  - **type**: è³‡æ–™é¡å‹ï¼ˆordered_hash_key, array_item, dict_value ç­‰ï¼‰

## åŠŸèƒ½ç‰¹é»

### extract.py

- âœ… è§£æ Ruby Marshal æ ¼å¼çš„äºŒé€²ä½è³‡æ–™
- âœ… è™•ç† OrderedHashã€é™£åˆ—ã€å­—å…¸ç­‰è¤‡é›œè³‡æ–™çµæ§‹
- âœ… è‡ªå‹•è™•ç† UTF-8 å’Œ Latin-1 ç·¨ç¢¼
- âœ… æä¾›è©³ç´°çš„ä¸Šä¸‹æ–‡è³‡è¨Š
- âœ… é€²åº¦é¡¯ç¤ºå’ŒéŒ¯èª¤è™•ç†
- âœ… é¡¯ç¤ºæå–æ¨£æœ¬ä¾›å¿«é€Ÿé©—è­‰

### repack.py

- âœ… å°‡ç¿»è­¯å¾Œçš„ JSON é‡æ–°æ‰“åŒ…ç‚º Ruby Marshal æ ¼å¼
- âœ… è‡ªå‹•åµæ¸¬åŸå§‹æª”æ¡ˆä½ç½®
- âœ… ä¿æŒåŸå§‹è³‡æ–™çµæ§‹å®Œæ•´æ€§
- âœ… è‡ªå‹•é©—è­‰æ‰“åŒ…å¾Œçš„æª”æ¡ˆå¯è®€æ€§
- âœ… é¡¯ç¤ºç¿»è­¯çµ±è¨ˆè³‡è¨Š
- âœ… æ”¯æ´å¢é‡ç¿»è­¯ï¼ˆåªç¿»è­¯éƒ¨åˆ†å…§å®¹ï¼‰

## æ¸¬è©¦çµæœ

### extract.py

åœ¨ `Data/messages.dat` ä¸ŠåŸ·è¡ŒæˆåŠŸï¼š
- âœ… æˆåŠŸæå– **28,599** å€‹æ–‡å­—æ¢ç›®
- âœ… è¼¸å‡ºæª”æ¡ˆå¤§å°: ~7 MB
- âœ… JSON æ ¼å¼æ­£ç¢ºï¼ŒåŒ…å«å®Œæ•´çš„å…ƒè³‡æ–™å’Œä¸Šä¸‹æ–‡
- âœ… æ”¯æ´è¥¿ç­ç‰™æ–‡ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ Ã¡, Ã©, Ã­, Ã³, Ãº, Ã±, Â¿, Â¡ï¼‰

### repack.py

é‡æ–°æ‰“åŒ…æ¸¬è©¦çµæœï¼š
- âœ… æˆåŠŸé‡æ–°æ‰“åŒ…æœªä¿®æ”¹çš„ JSONï¼ˆæª”æ¡ˆå¤§å°å®Œå…¨ä¸€è‡´ï¼‰
- âœ… æˆåŠŸæ‡‰ç”¨ç¿»è­¯ä¸¦é‡æ–°æ‰“åŒ…
- âœ… é©—è­‰é€šéï¼šé‡æ–°æå–é¡¯ç¤ºç¿»è­¯æ­£ç¢ºæ‡‰ç”¨
- âœ… æ”¯æ´ OrderedHash ç­‰ Ruby ç‰¹æ®Šè³‡æ–™çµæ§‹
- âœ… ä¿æŒæª”æ¡ˆæ ¼å¼å®Œæ•´æ€§

## æ•…éšœæ’é™¤

### éŒ¯èª¤: rubymarshal library not found

åŸ·è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£ä¾è³´ï¼š
```bash
pip install rubymarshal
```

### ç·¨ç¢¼éŒ¯èª¤

å·¥å…·æœƒè‡ªå‹•å˜—è©¦ UTF-8 å’Œ Latin-1 ç·¨ç¢¼ã€‚å¦‚æœä»æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥è¼¸å…¥æª”æ¡ˆçš„ç·¨ç¢¼æ ¼å¼ã€‚

### extract.py: ç©ºç™½è¼¸å‡º

ç¢ºä¿è¼¸å…¥æª”æ¡ˆæ˜¯æœ‰æ•ˆçš„ Ruby Marshal æ ¼å¼æª”æ¡ˆã€‚æŸäº›æª”æ¡ˆå¯èƒ½ä½¿ç”¨ä¸åŒçš„æ ¼å¼ã€‚

### repack.py: ç¿»è­¯æ²’æœ‰æ‡‰ç”¨

1. æª¢æŸ¥ JSON æ ¼å¼æ˜¯å¦æ­£ç¢º
2. ç¢ºä¿ `id` æ¬„ä½èˆ‡åŸå§‹æå–çš„ä¸€è‡´
3. ç¢ºä¿ `translation` æ¬„ä½ä¸ç‚ºç©º
4. ä½¿ç”¨ extract.py é‡æ–°æå–æ‰“åŒ…å¾Œçš„æª”æ¡ˆä¾†é©—è­‰

### repack.py: éŠæˆ²å´©æ½°

1. ç¢ºä¿æ²’æœ‰ç ´å£ HTML æ¨™è¨˜ï¼ˆå¦‚ `<b>`, `</b>`ï¼‰
2. ä¿ç•™ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ `\n` æ›è¡Œç¬¦ï¼‰
3. æª¢æŸ¥æª”æ¡ˆå¤§å°æ˜¯å¦åˆç†ï¼ˆä¸æ‡‰ç›¸å·®å¤ªå¤§ï¼‰
4. å‚™ä»½åŸå§‹æª”æ¡ˆä¸¦é€æ­¥æ¸¬è©¦

## æ³¨æ„äº‹é …

- âš ï¸ **å‹™å¿…å‚™ä»½åŸå§‹æª”æ¡ˆ** - åœ¨ä¿®æ”¹éŠæˆ²æª”æ¡ˆå‰å…ˆå‚™ä»½
- ğŸ“ **ä¿ç•™æ ¼å¼æ¨™è¨˜** - HTML æ¨™è¨˜å’Œç‰¹æ®Šå­—ç¬¦ï¼ˆ`\n` ç­‰ï¼‰å¿…é ˆä¿ç•™
- ğŸ”¤ **ä½¿ç”¨ UTF-8 ç·¨ç¢¼** - ç·¨è¼¯ JSON æ™‚ä½¿ç”¨ UTF-8 ç·¨ç¢¼
- ğŸ§ª **å……åˆ†æ¸¬è©¦** - é‡æ–°æ‰“åŒ…å¾Œå‹™å¿…åœ¨éŠæˆ²ä¸­æ¸¬è©¦
- ğŸ“Š **æª”æ¡ˆå¤§å°** - é‡æ–°æ‰“åŒ…çš„æª”æ¡ˆå¤§å°å¯èƒ½å› ç¿»è­¯é•·åº¦è€Œç•¥æœ‰ä¸åŒ

## æ”¯æ´çš„æª”æ¡ˆé¡å‹

- `.dat` æª”æ¡ˆï¼ˆå¦‚ messages.dat, trainers.dat, items.dat ç­‰ï¼‰
- `.rxdata` æª”æ¡ˆï¼ˆåœ°åœ–è³‡æ–™ç­‰ï¼‰

**æ³¨æ„**: æŸäº›æª”æ¡ˆï¼ˆå¦‚ items.datï¼‰å¯èƒ½ä½¿ç”¨ä¸åŒçš„æ ¼å¼ï¼Œç›®å‰ä¸æ”¯æ´ã€‚

## ç›¸é—œå·¥å…·

- `extract_test.py`: ç”¨æ–¼æ¸¬è©¦å¤šå€‹æª”æ¡ˆçš„æå–åŠŸèƒ½
- `test_extract.py`: èˆŠç‰ˆæ¸¬è©¦å·¥å…·

## ç‰ˆæœ¬æ­·å²

- **v1.0** (2024): extract.py åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æ´åŸºæœ¬æå–åŠŸèƒ½
- **v1.1** (2026-02): 
  - æ–°å¢ repack.py å·¥å…·
  - ä¿®æ­£ OrderedHash è™•ç†
  - æ”¹é€²éŒ¯èª¤è™•ç†å’Œé©—è­‰
  - å®Œæ•´çš„æ¸¬è©¦å’Œæ–‡ä»¶
